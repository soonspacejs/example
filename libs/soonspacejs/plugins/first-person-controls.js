import{Vector3 as t,Vector2 as e,Sphere as s,Box3 as i,Raycaster as n,Matrix4 as o,Euler as a,Quaternion as r}from"three";import h from"soonspacejs";function c(t,e){const s=h.utils.getBoundingBox(e);return t.intersectsBox(s)}function l(t,e){t.disableAll();for(const s of e)t.enable(s)}const d=1e-5;function p(t,e,s=d){return function(t,e=d){return Math.abs(t)<e}(t-e,s)}const{utils:v}=h;class y{get rotate(){return this._rotate&&(this.horizontalRotate||this.verticalRotate)}set rotate(t){this._rotate=t}constructor(n){this.enabled=!1,this.state={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1,moveUp:!1,moveDown:!1,canJump:!1,canRotate:!1},this.moveSpeed=10,this.gravitySpeed=10,this.jumpOffset=0,this.clashCheckDistance=200,this.clashDistance=50,this.eyeHeight=160,this.kneeHeight=50,this.jumpHeight=110,this.enableClash=!0,this.enableGravity=!0,this.reverseRotate=!1,this._rotate=!0,this.rotateSpeed=1,this.horizontalRotate=!0,this.verticalRotate=!0,this.dblClickForward=!1,this.velocity=new t,this.movement=new e,this._dblVector=new t,this._dblDeltaVector=new t,this._pointerId=null,this.lastDirection=new t,this.searchRadiusFactor=3,this.checkedSphere=new s,this.gravitySearchFactor=3,this.gravityCheckedObjects=null,this.gravityCheckedBox=new i,this.gravityInterObject=null,this.kneeInterObject=null,this.eyeInterObject=null,this.ssp=n,this.viewport=n.viewport,this.controls=n.controls,this.camera=n.controls.camera,this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onDblClick=this.onDblClick.bind(this),this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this)}onKeyDown(t){if(!1!==this.enabled){switch(t.code){case"ArrowUp":case"KeyW":this.state.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.state.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.state.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.state.moveRight=!0;break;case"KeyI":this.state.canRotate=!0,this.movement.x=0,this.movement.y=-10;break;case"KeyJ":this.state.canRotate=!0,this.movement.x=-10,this.movement.y=0;break;case"KeyK":this.state.canRotate=!0,this.movement.x=0,this.movement.y=10;break;case"KeyL":this.state.canRotate=!0,this.movement.x=10,this.movement.y=0;break;case"KeyQ":this.state.moveUp=!0;break;case"KeyE":this.state.moveDown=!0;break;case"Space":!0===this.state.canJump&&!1===t.repeat&&(this.jumpOffset=this.jumpHeight),this.state.canJump=!1}(this.jumpOffset>0||Object.values(this.state).some((t=>t)))&&this.ssp.render()}}onKeyUp(t){if(!1!==this.enabled)switch(t.code){case"ArrowUp":case"KeyW":this.state.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.state.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.state.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.state.moveRight=!1;break;case"KeyI":case"KeyJ":case"KeyK":case"KeyL":this.state.canRotate=!1;break;case"KeyQ":this.state.moveUp=!1;break;case"KeyE":this.state.moveDown=!1}}onDblClick(t){if(!0===this.dblClickForward){const[e]=this.ssp.viewport.getIntersects(t);if(e){const{point:t}=e;t.y+=this.eyeHeight,t.sub(this.camera.position),this._dblVector.copy(t),this._dblDeltaVector.set(0,0,0),this.ssp.render()}}}onPointerDown(t){null===this._pointerId&&0===t.button&&(this._pointerId=t.pointerId,this.state.canRotate=!0)}onPointerMove(t){if(this.enabled&&this.state.canRotate){let e=t.movementY,s=t.movementX;this.reverseRotate&&(s=-s,e=-e),this.movement.x=s,this.movement.y=e,this.ssp.render()}}onPointerUp(t){null!==this._pointerId&&(this._pointerId=null,this.state.canRotate=!1)}clearClashCache(){this.kneeInterObject=null,this.eyeInterObject=null}onClashCheck(t,e){const s=e.length(),i=e.clone().divideScalar(s);i.distanceToSquared(this.lastDirection)>1e-9&&this.clearClashCache(),this.lastDirection=i;const{eyeHeight:o,kneeHeight:a,camera:r,clashCheckDistance:h,clashDistance:c,clashLayers:d}=this;let{kneeInterObject:p,eyeInterObject:v}=this;if(!p){const e=t.clone().setY(t.y-o+a),s=new n(e,i,0,h);s.firstHitOnly=!0,null!=d&&l(s.layers,d),s.camera=r;const c=this.getCheckedObjects(e),v=s.intersectObjects(c);this.kneeInterObject=p=v[0]}let y=-s;if(p&&(y+=p.distance,y<c))return!0;if(!v){const e=new n(t,i,0,h);e.firstHitOnly=!0,null!=d&&l(e.layers,d),e.camera=r;const s=this.getCheckedObjects(t),o=e.intersectObjects(s);this.eyeInterObject=v=o[0]}let m=-s;if(v){if(m+=v.distance,m<c)return!0;v.distance=m}return p&&(p.distance=y),!1}getCheckedObjects(t){const{clashDistance:e,clashCheckDistance:s,searchRadiusFactor:i,clashFilter:n}=this,o=s*i,a=this.checkedSphere,r=o+e;a.set(t,r);const h=null!=n?n:function(){return!0};return this.viewport.scener.intersectsList.getAll().filter((t=>!!h(t)&&c(a,t)))}getGravityCheckedObjects(e,s){const i=this.gravityCheckedBox;let n=this.gravityCheckedObjects;if(n){const t=e.clone();t.y=s,i.containsPoint(e)&&i.containsPoint(t)||(n=null)}if(!n){const{eyeHeight:s,clashCheckDistance:o,gravitySearchFactor:a,clashDistance:r,clashFilter:h}=this,l=o+r,d=new t(l,l,0),p=e.clone().add(d),v=e.clone().sub(d);v.y-=s*a,i.set(v,p);const y=this.viewport.scener.intersectsList.getAll(),m=null!=h?h:function(){return!0};n=y.filter((t=>!!m(t)&&c(i,t)))}return n}gravityClashCheck(e,s){var i;let a=this.gravityInterObject;if(a){const{object:s,face:n,instanceId:r}=a,h=null===(i=s.geometry)||void 0===i?void 0:i.getAttribute("position");if(h&&n){let i=a.facePoints;if(!i){let e=s.matrixWorld;if(null!=r){const t=new o;s.getMatrixAt(r,t),e=t.premultiply(e)}const{a:c,b:l,c:d}=n,p=new t(h.getX(c),h.getY(c),h.getZ(c));p.applyMatrix4(e),p.setY(0);const v=new t(h.getX(l),h.getY(l),h.getZ(l));v.applyMatrix4(e),v.setY(0);const y=new t(h.getX(d),h.getY(d),h.getZ(d));y.applyMatrix4(e),y.setY(0),a.facePoints=i=[p,v,y]}let c=i[2],l=null;const d=e.clone();d.y=0;i.every((t=>{const e=t.clone();e.sub(c);const s=d.clone();if(s.sub(c),e.cross(s),l){if(e.dot(l)<=0)return!1}return l=e,c=t,!0}))||(this.gravityInterObject=a=null)}}if(!a){const i=new n(e,new t(0,-1,0));i.firstHitOnly=!0;const o=this.clashLayers;null!=o&&l(i.layers,o),i.camera=this.camera;const r=this.getGravityCheckedObjects(e,s),h=i.intersectObjects(r);this.gravityInterObject=a=h[0]}return a}setOptions(e){const{position:s=new t,rotation:i=new a,moveSpeed:n,eyeHeight:o,kneeHeight:r,jumpHeight:h,enableClash:c,enableGravity:l,searchRadiusFactor:p,clashDistance:y,clashCheckDistance:m,gravitySpeed:b,gravitySearchFactor:u,reverseRotate:g,rotate:w,rotateSpeed:k,horizontalRotate:f,verticalRotate:C,dblClickForward:D,clashFilter:j,clashLayers:O}=e;if(o&&(this.eyeHeight=o),r&&(this.kneeHeight=r),h&&(this.jumpHeight=h),p&&(this.searchRadiusFactor=p),y&&(this.clashDistance=y),m&&(this.clashCheckDistance=m),b&&(this.gravitySpeed=b),u&&(this.gravitySearchFactor=u),null!=g&&(this.reverseRotate=g),null!=w&&(this.rotate=w),null!=f&&(this.horizontalRotate=f),null!=C&&(this.verticalRotate=C),v.isBoolean(D)&&(this.dblClickForward=D),v.isNumber(k)&&(this.rotateSpeed=k),null!=c&&(this.enableClash=c),null!=l&&(this.enableGravity=l),null!=j&&(this.clashFilter=j),null!=O&&(this.clashLayers=O),s&&(this.controls.setPosition(s.x,s.y+this.eyeHeight,s.z),this.gravityInterObject=null,this.clearClashCache()),i){const e=v.computeTargetByRotation(this.controls.getPosition(new t),i,d);this.controls.setTarget(e.x,e.y,e.z)}n&&(this.moveSpeed=n)}start(t){this.viewport.controls.saveState(),this.viewport.controls.enabled=!1,this.enabled=!0,this.setOptions(t),this.viewport.postRender.set("FirstPersonControls",this.update.bind(this)),this.ssp.signals.dblClick.add(this.onDblClick),this.ssp.signals.keyDown.add(this.onKeyDown),this.ssp.signals.keyUp.add(this.onKeyUp);const e=this.viewport.container;e.addEventListener("pointerdown",this.onPointerDown),e.addEventListener("pointermove",this.onPointerMove),e.addEventListener("pointerup",this.onPointerUp)}stop(){this.viewport.controls.reset(),this.viewport.controls.enabled=!0,this.enabled=!1,this.viewport.postRender.delete("FirstPersonControls"),this.ssp.signals.dblClick.remove(this.onDblClick),this.ssp.signals.keyDown.remove(this.onKeyDown),this.ssp.signals.keyUp.remove(this.onKeyUp);const t=this.viewport.container;t.removeEventListener("pointerdown",this.onPointerDown),t.removeEventListener("pointermove",this.onPointerMove),t.removeEventListener("pointerup",this.onPointerUp),this.ssp.render()}update(){if(!this.enabled)return;const{delta:e}=this.viewport.state,s=new t,{controls:i,state:n,camera:o,eyeHeight:h,kneeHeight:c}=this,l=i.getPosition(new t),v=20*this.moveSpeed,y=20*this.gravitySpeed;n.moveForward&&(s.z-=v),n.moveBackward&&(s.z+=v),n.moveLeft&&(s.x-=v),n.moveRight&&(s.x+=v),n.moveUp&&(s.y+=2*y),n.moveDown&&(s.y-=2*y),s.multiplyScalar(e);const{x:m,y:b}=this.movement,u=this.horizontalRotate&&0!==m,g=this.verticalRotate&&0!==b;if(this.rotate&&n.canRotate&&(u||g)){let{azimuthAngle:t,polarAngle:e}=i;g&&(e-=.003*b*this.rotateSpeed),u&&(t-=.003*m*this.rotateSpeed),i.rotateTo(t,e)}const w=new a(0,0,0,"YXZ");if(w.setFromQuaternion(o.quaternion),0!==w.y&&!s.equals(new t)){const e=new r;e.setFromAxisAngle(new t(0,1,0),w.y),s.applyQuaternion(e)}if(!this._dblVector.equals(new t)){const t=this._dblVector.clone().multiplyScalar(e);this._dblDeltaVector.add(t),this._dblDeltaVector.length()>this._dblVector.length()?(this._dblVector.set(0,0,0),this._dblDeltaVector.set(0,0,0)):s.add(t)}const k=l.clone();if((!this.enableClash||!this.onClashCheck(l,s))&&(k.add(s),this.gravityInterObject)){const t=this.gravityInterObject.point.clone().sub(k);t.y=0,t.length()>c&&(this.gravityInterObject=null)}let f=k.y;if(this.enableGravity){const t=f;this.jumpOffset>0&&(this.jumpOffset-=y*e,f+=2*y*e),f-=y*e,n.canJump=!1;const s=this.gravityClashCheck(k,f);if(s){const t=s.point.y+h;f<t&&(f=t,this.jumpOffset=0,n.canJump=!0)}t!==f&&this.clearClashCache()}k.y=f,p(l.x,k.x)&&p(l.y,k.y)&&p(l.z,k.z)||(i.moveTo(k.x,k.y,k.z),i.dollyTo(d))}}export{y as default};
