import{Raycaster as t,Vector3 as e,Quaternion as i,Object3D as n,Euler as o,Matrix4 as s,MeshBasicMaterial as a,LineBasicMaterial as r,CylinderGeometry as h,BoxGeometry as l,BufferGeometry as c,Float32BufferAttribute as p,Mesh as d,OctahedronGeometry as m,Line as u,SphereGeometry as w,TorusGeometry as y,PlaneGeometry as v,DoubleSide as b}from"three";const g=new t,M=new e,P=new e,S=new i,x={X:new e(1,0,0),Y:new e(0,1,0),Z:new e(0,0,1)},_={type:"change"},f={type:"mouseDown"},E={type:"mouseUp",mode:null},I={type:"objectChange"};class X extends n{constructor(t,n){super(),void 0===n&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),n=document),this.isTransformControls=!0,this.visible=!1,this.domElement=n,this.domElement.style.touchAction="none";const o=new B;this._gizmo=o,this.add(o);const s=new J;this._plane=s,this.add(s);const a=this;function r(t,e){let i=e;Object.defineProperty(a,t,{get:function(){return void 0!==i?i:e},set:function(e){i!==e&&(i=e,s[t]=e,o[t]=e,a.dispatchEvent({type:t+"-changed",value:e}),a.dispatchEvent(_))}}),a[t]=e,s[t]=e,o[t]=e}r("camera",t),r("object",void 0),r("enabled",!0),r("axis",null),r("mode","translate"),r("translationSnap",null),r("rotationSnap",null),r("scaleSnap",null),r("space","world"),r("size",1),r("dragging",!1),r("showX",!0),r("showY",!0),r("showZ",!0);const h=new e,l=new e,c=new i,p=new i,d=new e,m=new i,u=new e,w=new e,y=new e,v=new e;r("worldPosition",h),r("worldPositionStart",l),r("worldQuaternion",c),r("worldQuaternionStart",p),r("cameraPosition",d),r("cameraQuaternion",m),r("pointStart",u),r("pointEnd",w),r("rotationAxis",y),r("rotationAngle",0),r("eye",v),this._offset=new e,this._startNorm=new e,this._endNorm=new e,this._cameraScale=new e,this._parentPosition=new e,this._parentQuaternion=new i,this._parentQuaternionInv=new i,this._parentScale=new e,this._worldScaleStart=new e,this._worldQuaternionInv=new i,this._worldScale=new e,this._positionStart=new e,this._quaternionStart=new i,this._scaleStart=new e,this._getPointer=Q.bind(this),this._onPointerDown=Z.bind(this),this._onPointerHover=Y.bind(this),this._onPointerMove=A.bind(this),this._onPointerUp=z.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(t){if(void 0===this.object||!0===this.dragging)return;g.setFromCamera(t,this.camera);const e=j(this._gizmo.picker[this.mode],g);this.axis=e?e.object.name:null}pointerDown(t){if(void 0!==this.object&&!0!==this.dragging&&0===t.button&&null!==this.axis){g.setFromCamera(t,this.camera);const e=j(this._plane,g,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,f.mode=this.mode,this.dispatchEvent(f)}}pointerMove(t){const e=this.axis,i=this.mode,n=this.object;let o=this.space;if("scale"===i?o="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(o="world"),void 0===n||null===e||!1===this.dragging||-1!==t.button)return;g.setFromCamera(t,this.camera);const s=j(this._plane,g,!0);if(s){if(this.pointEnd.copy(s.point).sub(this.worldPositionStart),"translate"===i)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===o&&"XYZ"!==e&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===e.indexOf("X")&&(this._offset.x=0),-1===e.indexOf("Y")&&(this._offset.y=0),-1===e.indexOf("Z")&&(this._offset.z=0),"local"===o&&"XYZ"!==e?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),n.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===o&&(n.position.applyQuaternion(S.copy(this._quaternionStart).invert()),-1!==e.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.position.applyQuaternion(this._quaternionStart)),"world"===o&&(n.parent&&n.position.add(M.setFromMatrixPosition(n.parent.matrixWorld)),-1!==e.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.parent&&n.position.sub(M.setFromMatrixPosition(n.parent.matrixWorld))));else if("scale"===i){if(-1!==e.search("XYZ")){let t=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(t*=-1),P.set(t,t,t)}else M.copy(this.pointStart),P.copy(this.pointEnd),M.applyQuaternion(this._worldQuaternionInv),P.applyQuaternion(this._worldQuaternionInv),P.divide(M),-1===e.search("X")&&(P.x=1),-1===e.search("Y")&&(P.y=1),-1===e.search("Z")&&(P.z=1);n.scale.copy(this._scaleStart).multiply(P),this.scaleSnap&&(-1!==e.search("X")&&(n.scale.x=Math.round(n.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Y")&&(n.scale.y=Math.round(n.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==e.search("Z")&&(n.scale.z=Math.round(n.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===i){this._offset.copy(this.pointEnd).sub(this.pointStart);const t=20/this.worldPosition.distanceTo(M.setFromMatrixPosition(this.camera.matrixWorld));"E"===e?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1):"XYZE"===e?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(M.copy(this.rotationAxis).cross(this.eye))*t):"X"!==e&&"Y"!==e&&"Z"!==e||(this.rotationAxis.copy(x[e]),M.copy(x[e]),"local"===o&&M.applyQuaternion(this.worldQuaternion),this.rotationAngle=this._offset.dot(M.cross(this.eye).normalize())*t),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===o&&"E"!==e&&"XYZE"!==e?(n.quaternion.copy(this._quaternionStart),n.quaternion.multiply(S.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),n.quaternion.copy(S.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),n.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(_),this.dispatchEvent(I)}}pointerUp(t){0===t.button&&(this.dragging&&null!==this.axis&&(E.mode=this.mode,this.dispatchEvent(E)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse((function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}))}attach(t){return this.object=t,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(_),this.dispatchEvent(I),this.pointStart.copy(this.pointEnd))}getRaycaster(){return g}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function Q(t){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:t.button};{const e=this.domElement.getBoundingClientRect();return{x:(t.clientX-e.left)/e.width*2-1,y:-(t.clientY-e.top)/e.height*2+1,button:t.button}}}function Y(t){if(this.enabled)switch(t.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(t))}}function Z(t){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(t.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(t)),this.pointerDown(this._getPointer(t)))}function A(t){this.enabled&&this.pointerMove(this._getPointer(t))}function z(t){this.enabled&&(this.domElement.releasePointerCapture(t.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(t)))}function j(t,e,i){const n=e.intersectObject(t,!0);for(let t=0;t<n.length;t++)if(n[t].object.visible||i)return n[t];return!1}const q=new o,T=new e(0,1,0),C=new e(0,0,0),k=new s,W=new i,F=new i,H=new e,D=new s,L=new e(1,0,0),O=new e(0,1,0),R=new e(0,0,1),N=new e,U=new e,G=new e;class B extends n{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new a({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new r({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=t.clone();i.opacity=.15;const o=e.clone();o.opacity=.5;const s=t.clone();s.color.setHex(16711680);const v=t.clone();v.color.setHex(65280);const b=t.clone();b.color.setHex(255);const g=t.clone();g.color.setHex(16711680),g.opacity=.5;const M=t.clone();M.color.setHex(65280),M.opacity=.5;const P=t.clone();P.color.setHex(255),P.opacity=.5;const S=t.clone();S.opacity=.25;const x=t.clone();x.color.setHex(16776960),x.opacity=.25;t.clone().color.setHex(16776960);const _=t.clone();_.color.setHex(7895160);const f=new h(0,.04,.1,12);f.translate(0,.05,0);const E=new l(.08,.08,.08);E.translate(0,.04,0);const I=new c;I.setAttribute("position",new p([0,0,0,1,0,0],3));const X=new h(.0075,.0075,.5,3);function Q(t,e){const i=new y(t,.0075,3,64,e*Math.PI*2);return i.rotateY(Math.PI/2),i.rotateX(Math.PI/2),i}X.translate(0,.25,0);const Y={X:[[new d(f,s),[.5,0,0],[0,0,-Math.PI/2]],[new d(f,s),[-.5,0,0],[0,0,Math.PI/2]],[new d(X,s),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new d(f,v),[0,.5,0]],[new d(f,v),[0,-.5,0],[Math.PI,0,0]],[new d(X,v)]],Z:[[new d(f,b),[0,0,.5],[Math.PI/2,0,0]],[new d(f,b),[0,0,-.5],[-Math.PI/2,0,0]],[new d(X,b),null,[Math.PI/2,0,0]]],XYZ:[[new d(new m(.1,0),S.clone()),[0,0,0]]],XY:[[new d(new l(.15,.15,.01),P.clone()),[.15,.15,0]]],YZ:[[new d(new l(.15,.15,.01),g.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new d(new l(.15,.15,.01),M.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},Z={X:[[new d(new h(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new d(new h(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new d(new h(.2,0,.6,4),i),[0,.3,0]],[new d(new h(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new d(new h(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new d(new h(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new d(new m(.2,0),i)]],XY:[[new d(new l(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new d(new l(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new d(new l(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},A={START:[[new d(new m(.01,2),o),null,null,null,"helper"]],END:[[new d(new m(.01,2),o),null,null,null,"helper"]],DELTA:[[new u(function(){const t=new c;return t.setAttribute("position",new p([0,0,0,1,1,1],3)),t}(),o),null,null,null,"helper"]],X:[[new u(I,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new u(I,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new u(I,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},z={XYZE:[[new d(Q(.5,1),_),null,[0,Math.PI/2,0]]],X:[[new d(Q(.5,.5),s)]],Y:[[new d(Q(.5,.5),v),null,[0,0,-Math.PI/2]]],Z:[[new d(Q(.5,.5),b),null,[0,Math.PI/2,0]]],E:[[new d(Q(.75,1),x),null,[0,Math.PI/2,0]]]},j={AXIS:[[new u(I,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},q={XYZE:[[new d(new w(.25,10,8),i)]],X:[[new d(new y(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new d(new y(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new d(new y(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new d(new y(.75,.1,2,24),i)]]},T={X:[[new d(E,s),[.5,0,0],[0,0,-Math.PI/2]],[new d(X,s),[0,0,0],[0,0,-Math.PI/2]],[new d(E,s),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new d(E,v),[0,.5,0]],[new d(X,v)],[new d(E,v),[0,-.5,0],[0,0,Math.PI]]],Z:[[new d(E,b),[0,0,.5],[Math.PI/2,0,0]],[new d(X,b),[0,0,0],[Math.PI/2,0,0]],[new d(E,b),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new d(new l(.15,.15,.01),P),[.15,.15,0]]],YZ:[[new d(new l(.15,.15,.01),g),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new d(new l(.15,.15,.01),M),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new d(new l(.1,.1,.1),S.clone())]]},C={X:[[new d(new h(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new d(new h(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new d(new h(.2,0,.6,4),i),[0,.3,0]],[new d(new h(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new d(new h(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new d(new h(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new d(new l(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new d(new l(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new d(new l(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new d(new l(.2,.2,.2),i),[0,0,0]]]},k={X:[[new u(I,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new u(I,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new u(I,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function W(t){const e=new n;for(const i in t)for(let n=t[i].length;n--;){const o=t[i][n][0].clone(),s=t[i][n][1],a=t[i][n][2],r=t[i][n][3],h=t[i][n][4];o.name=i,o.tag=h,s&&o.position.set(s[0],s[1],s[2]),a&&o.rotation.set(a[0],a[1],a[2]),r&&o.scale.set(r[0],r[1],r[2]),o.updateMatrix();const l=o.geometry.clone();l.applyMatrix4(o.matrix),o.geometry=l,o.renderOrder=1/0,o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1),e.add(o)}return e}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=W(Y)),this.add(this.gizmo.rotate=W(z)),this.add(this.gizmo.scale=W(T)),this.add(this.picker.translate=W(Z)),this.add(this.picker.rotate=W(q)),this.add(this.picker.scale=W(C)),this.add(this.helper.translate=W(A)),this.add(this.helper.rotate=W(j)),this.add(this.helper.scale=W(k)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:F;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let i=[];i=i.concat(this.picker[this.mode].children),i=i.concat(this.gizmo[this.mode].children),i=i.concat(this.helper[this.mode].children);for(let t=0;t<i.length;t++){const n=i[t];let o;if(n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition),o=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),n.scale.set(1,1,1).multiplyScalar(o*this.size/4),"helper"!==n.tag){if(n.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){const t=.99,i=.2;"X"===n.name&&Math.abs(T.copy(L).applyQuaternion(e).dot(this.eye))>t&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Y"===n.name&&Math.abs(T.copy(O).applyQuaternion(e).dot(this.eye))>t&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Z"===n.name&&Math.abs(T.copy(R).applyQuaternion(e).dot(this.eye))>t&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XY"===n.name&&Math.abs(T.copy(R).applyQuaternion(e).dot(this.eye))<i&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"YZ"===n.name&&Math.abs(T.copy(L).applyQuaternion(e).dot(this.eye))<i&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XZ"===n.name&&Math.abs(T.copy(O).applyQuaternion(e).dot(this.eye))<i&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1)}else"rotate"===this.mode&&(W.copy(e),T.copy(this.eye).applyQuaternion(S.copy(e).invert()),-1!==n.name.search("E")&&n.quaternion.setFromRotationMatrix(k.lookAt(this.eye,C,O)),"X"===n.name&&(S.setFromAxisAngle(L,Math.atan2(-T.y,T.z)),S.multiplyQuaternions(W,S),n.quaternion.copy(S)),"Y"===n.name&&(S.setFromAxisAngle(O,Math.atan2(T.x,T.z)),S.multiplyQuaternions(W,S),n.quaternion.copy(S)),"Z"===n.name&&(S.setFromAxisAngle(R,Math.atan2(T.y,T.x)),S.multiplyQuaternions(W,S),n.quaternion.copy(S)));n.visible=n.visible&&(-1===n.name.indexOf("X")||this.showX),n.visible=n.visible&&(-1===n.name.indexOf("Y")||this.showY),n.visible=n.visible&&(-1===n.name.indexOf("Z")||this.showZ),n.visible=n.visible&&(-1===n.name.indexOf("E")||this.showX&&this.showY&&this.showZ),n.material._color=n.material._color||n.material.color.clone(),n.material._opacity=n.material._opacity||n.material.opacity,n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled&&this.axis&&(n.name===this.axis||this.axis.split("").some((function(t){return n.name===t})))&&(n.material.color.setHex(16776960),n.material.opacity=1)}else n.visible=!1,"AXIS"===n.name?(n.visible=!!this.axis,"X"===this.axis&&(S.setFromEuler(q.set(0,0,0)),n.quaternion.copy(e).multiply(S),Math.abs(T.copy(L).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"Y"===this.axis&&(S.setFromEuler(q.set(0,0,Math.PI/2)),n.quaternion.copy(e).multiply(S),Math.abs(T.copy(O).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"Z"===this.axis&&(S.setFromEuler(q.set(0,Math.PI/2,0)),n.quaternion.copy(e).multiply(S),Math.abs(T.copy(R).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"XYZE"===this.axis&&(S.setFromEuler(q.set(0,Math.PI/2,0)),T.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(k.lookAt(C,T,O)),n.quaternion.multiply(S),n.visible=this.dragging),"E"===this.axis&&(n.visible=!1)):"START"===n.name?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):"END"===n.name?(n.position.copy(this.worldPosition),n.visible=this.dragging):"DELTA"===n.name?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),M.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),M.applyQuaternion(this.worldQuaternionStart.clone().invert()),n.scale.copy(M),n.visible=this.dragging):(n.quaternion.copy(e),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=-1!==this.axis.search(n.name)))}super.updateMatrixWorld(t)}}class J extends d{constructor(){super(new v(1e5,1e5,2,2),new a({visible:!1,wireframe:!0,side:b,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),N.copy(L).applyQuaternion("local"===e?this.worldQuaternion:F),U.copy(O).applyQuaternion("local"===e?this.worldQuaternion:F),G.copy(R).applyQuaternion("local"===e?this.worldQuaternion:F),T.copy(U),this.mode){case"translate":case"scale":switch(this.axis){case"X":T.copy(this.eye).cross(N),H.copy(N).cross(T);break;case"Y":T.copy(this.eye).cross(U),H.copy(U).cross(T);break;case"Z":T.copy(this.eye).cross(G),H.copy(G).cross(T);break;case"XY":H.copy(G);break;case"YZ":H.copy(N);break;case"XZ":T.copy(G),H.copy(U);break;case"XYZ":case"E":H.set(0,0,0)}break;default:H.set(0,0,0)}0===H.length()?this.quaternion.copy(this.cameraQuaternion):(D.lookAt(M.set(0,0,0),H,T),this.quaternion.setFromRotationMatrix(D)),super.updateMatrixWorld(t)}}class K{constructor(t){this.ssp=t,this.control=null,this.options=null}start(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{mode:i="translate",onUpdate:n,onDragStart:o,onDragEnd:s}=e;return this.options=e,this.control=new X(this.ssp.viewport.camera,this.ssp.viewport.rendererManager.interactiveContainer),this.control.attach(t),this.control.setMode(i),this.control.addEventListener("dragging-changed",(e=>{this.ssp.viewport.controls.currentControls.enabled=!e.value,e.value?null==o||o(t):null==s||s(t)})),this.control.addEventListener("objectChange",(()=>{null==n||n(t),this.ssp.signals.objectChanged.dispatch(t)})),this.ssp.addObject(this.control),this.control}close(){var t,e;this.control&&(this.ssp.removeObject(this.control),this.control.detach(),this.control=null,null===(e=null===(t=this.options)||void 0===t?void 0:t.onClose)||void 0===e||e.call(t))}changeMode(t){var e,i;t&&(null===(i=null===(e=this.control)||void 0===e?void 0:e.setMode)||void 0===i||i.call(e,t),this.ssp.signals.objectChanged.dispatch())}}export{K as default};
