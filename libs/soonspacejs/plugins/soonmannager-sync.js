const e=1;class s{get nodesShowLevel(){return this._nodesShowLevel}set nodesShowLevel(e){e!==this._nodesShowLevel&&(this.needsUpdateHideNodes=!0),this._nodesShowLevel=e}constructor(e){this.ssp=e,this.poiInfo=[],this.treeData=[],this.mapData=new Map,this.isLoaded=!1,this.isPausedRenderWhileLoadingRest=!1,this.nodesHideExclude=new Set,this._nodesShowLevel=-1,this.currentNeedsHideNodesVisible=!0,this.needsHideNodes=new Set,this.needsUpdateHideNodes=!1,this.idleTaskList=[],this.format3DInfo=e=>{const{utils:{deg2Euler:s}}=this.ssp,{id:t,filepath:i,modelname:a,x:o=0,y:d=0,z:n=0,rotation_x:l=0,rotation_y:r=0,rotation_z:h=0,scale_x:c=1,scale_y:p=1,scale_z:f=1,visible:u}=e;return{url:i?this.baseUrl+i:"",id:t,name:a,position:{x:o,y:d,z:n},rotation:{x:s(l),y:s(r),z:s(h)},scale:{x:c,y:p,z:f},visible:null==u||u,userData:Object.assign({},e)}},this.ssp=e,this.baseUrl=null,this._initInteractiveHideNodes()}_initInteractiveHideNodes(){const e=()=>{this.needsUpdateHideNodes&&0!==this.mapData.size&&(this.needsHideNodes.clear(),this.mapData.forEach((e=>{e.nodeLevel&&e.nodeLevel>this.nodesShowLevel&&this.needsHideNodes.add(e)})),this.needsUpdateHideNodes=!1)},s=e=>{e!==this.currentNeedsHideNodesVisible&&(this.currentNeedsHideNodesVisible=e,this.needsHideNodes.forEach((s=>{if(this.nodesHideExclude.has(s.id))return;const t=this.ssp.getObjectById(s.id);if(t){const[s]=t.children;s&&(s.visible=e,s.matrixAutoUpdate=e)}})),this.ssp.render())};let t=null;const i=()=>{t&&(clearTimeout(t),t=null)};this.ssp.signals.cameraChange.add((()=>{this.nodesShowLevel<0||(e(),i(),s(!1),t=window.setTimeout((()=>{s(!0),i()}),300))}))}setBaseUrl(e){this.baseUrl=e}async fetchInfo(e){return this.ssp.utils.fetchFile(`${this.baseUrl}db/${e}.json`,"json").catch((e=>console.error(e)))}async getPoiInfo(){return this.fetchInfo("poiInfo").then((e=>(this.poiInfo=e,Promise.resolve([...e])))).catch((e=>console.error(e)))}setGlobalSetting(e){console.warn("setGlobalSetting is deprecated")}async poiInfoData2Tree(){if(this.treeData.length>0)return;const s=[],t=new Set,i=await this.getPoiInfo();if(i){i.forEach((e=>{t.add(e.id)})),i.forEach((i=>{if(!t.has(i.pid)){const t=Object.assign(Object.assign({},i),{nodeLevel:e});this.mapData.set(t.id,t),s.push(t)}})),s.forEach((e=>{const s=i.findIndex((s=>s.id===e.id));-1!==s&&i.splice(s,1)}));const a=(e,s,t)=>{const i=[];e.forEach((e=>{if(e.pid===s.id){const s=Object.assign(Object.assign({},e),{nodeLevel:t});this.mapData.set(s.id,s),i.push(s)}})),i.length>0&&(s.children=i,s.children.forEach((s=>a(e,s,t+1))))};s.forEach((s=>a(i,s,e+1)))}this.treeData=s}async loadScene(){var s=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{targetId:i,targetLevel:a,isIdleRest:o=!0,loadSceneAllSuccess:d=(()=>{})}=t;this.isLoaded=!1,await this.poiInfoData2Tree();const n=this.treeData,l=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;if(!t||!t.length)return Promise.resolve();if("number"==typeof a&&+a>=e&&r>a)return Promise.resolve();const h=t.filter((e=>"3D"===e.category_type)).map((e=>s.format3DInfo(e)));if(i){if(n)return await s.loadRest(h,r,{isIdleRest:o,loadSceneAllSuccess:d}),void await Promise.allSettled(t.map((e=>l(e.children,!0,r+1))));const e=Array.isArray(i)?i:[i];for(const i of e){const e=h.find((e=>e.id===i));if(e){await s.loadSbmOrModel([e]);const a=t.find((e=>e.id===i));a&&await l(a.children,!0,r+1)}}await Promise.allSettled(t.map((e=>l(e.children,!1,r))))}else await s.loadRest(h,r,{isIdleRest:o,loadSceneAllSuccess:d}),await Promise.allSettled(t.map((e=>l(e.children,!1,r+1))))};await l(n),o&&a!==e&&0!==this.idleTaskList.length||(this.isLoaded=!0,this.ssp.viewport.setPauseRender(!1).then((()=>{d()})))}async loadRest(s,t,i){let{isIdleRest:a,loadSceneAllSuccess:o}=i;if(0!==s.length){if(a&&t>e){let e;const t=()=>{this.loadSbmOrModel(s).finally((()=>{const s=this.idleTaskList.findIndex((s=>s===e));-1!==s&&this.idleTaskList.splice(s,1),0!==this.idleTaskList.length||this.isLoaded||(this.isLoaded=!0,this.ssp.viewport.setPauseRender(!1).then((()=>{o()})))}))};return e="function"==typeof requestIdleCallback?requestIdleCallback(t):window.setTimeout(t),void this.idleTaskList.push(e)}await this.loadSbmOrModel(s)}}async loadSbmOrModel(s){if(!this.ssp.viewport.state.isDisposed&&Array.isArray(s)){let t="";if(s.length>0){const[i]=s;t=`${i.userData.pid}_group`,this.isPausedRenderWhileLoadingRest&&i.userData.nodeLevel>e&&this.ssp.viewport.setPauseRender(!0)}if(t){let e=this.ssp.getObjectById(t);e||(e=this.ssp.createGroup({id:t,name:t})),await Promise.allSettled([this.ssp.addModelForGroup(t,s)])}}}}export{s as default};
