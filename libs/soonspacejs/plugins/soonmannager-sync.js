function e(e,t,s,i){return new(s||(s=Promise))((function(o,d){function n(e){try{a(i.next(e))}catch(e){d(e)}}function l(e){try{a(i.throw(e))}catch(e){d(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,l)}a((i=i.apply(e,t||[])).next())}))}const t=1;class s{get nodesShowLevel(){return this._nodesShowLevel}set nodesShowLevel(e){e!==this._nodesShowLevel&&(this.needsUpdateHideNodes=!0),this._nodesShowLevel=e}constructor(e){this.ssp=e,this.poiInfo=[],this.treeData=[],this.mapData=new Map,this.isLoaded=!1,this.isPausedRenderWhileLoadingRest=!1,this.nodesHideExclude=new Set,this._nodesShowLevel=-1,this.currentNeedsHideNodesVisible=!0,this.needsHideNodes=new Set,this.needsUpdateHideNodes=!1,this.idleTaskList=[],this.format3DInfo=e=>{const{utils:{deg2Euler:t}}=this.ssp,{id:s,filepath:i,modelname:o,x:d=0,y:n=0,z:l=0,rotation_x:a=0,rotation_y:r=0,rotation_z:h=0,scale_x:c=1,scale_y:u=1,scale_z:f=1,visible:p}=e;return{url:i?this.baseUrl+i:"",id:s,name:o,position:{x:d,y:n,z:l},rotation:{x:t(a),y:t(r),z:t(h)},scale:{x:c,y:u,z:f},visible:null==p||p,userData:Object.assign({},e)}},this.ssp=e,this.baseUrl=null,this._initInteractiveHideNodes()}_initInteractiveHideNodes(){const e=()=>{this.needsUpdateHideNodes&&0!==this.mapData.size&&(this.needsHideNodes.clear(),this.mapData.forEach((e=>{e.nodeLevel&&e.nodeLevel>this.nodesShowLevel&&this.needsHideNodes.add(e)})),this.needsUpdateHideNodes=!1)},t=e=>{e!==this.currentNeedsHideNodesVisible&&(this.currentNeedsHideNodesVisible=e,this.needsHideNodes.forEach((t=>{if(this.nodesHideExclude.has(t.id))return;const s=this.ssp.getObjectById(t.id);if(s){const[t]=s.children;t&&(t.visible=e,t.matrixAutoUpdate=e)}})),this.ssp.render())};let s=null;const i=()=>{s&&(clearTimeout(s),s=null)};this.ssp.signals.cameraChange.add((()=>{this.nodesShowLevel<0||(e(),i(),t(!1),s=setTimeout((()=>{t(!0),i()}),300))}))}setBaseUrl(e){this.baseUrl=e}fetchInfo(t){return e(this,void 0,void 0,(function*(){return fetch(`${this.baseUrl}db/${t}.json`).then((e=>e.json())).catch((e=>console.error(e)))}))}getPoiInfo(){return e(this,void 0,void 0,(function*(){return this.fetchInfo("poiInfo").then((e=>(this.poiInfo=e,Promise.resolve([...e])))).catch((e=>console.error(e)))}))}setGlobalSetting(e){console.warn("setGlobalSetting is deprecated")}poiInfoData2Tree(){return e(this,void 0,void 0,(function*(){if(this.treeData.length>0)return;const e=[],s=new Set,i=yield this.getPoiInfo();if(i){i.forEach((e=>{s.add(e.id)})),i.forEach((i=>{if(!s.has(i.pid)){const s=Object.assign(Object.assign({},i),{nodeLevel:t});this.mapData.set(s.id,s),e.push(s)}})),e.forEach((e=>{const t=i.findIndex((t=>t.id===e.id));-1!==t&&i.splice(t,1)}));const o=(e,t,s)=>{const i=[];e.forEach((e=>{if(e.pid===t.id){const t=Object.assign(Object.assign({},e),{nodeLevel:s});this.mapData.set(t.id,t),i.push(t)}})),i.length>0&&(t.children=i,t.children.forEach((t=>o(e,t,s+1))))};e.forEach((e=>o(i,e,t+1)))}this.treeData=e}))}loadScene(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,void 0,void 0,(function*(){var i=this;const{targetId:o,targetLevel:d,isIdleRest:n=!0,loadSceneAllSuccess:l=(()=>{})}=s;this.isLoaded=!1,yield this.poiInfoData2Tree();const a=this.treeData,r=function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],h=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;return e(i,void 0,void 0,(function*(){if(!s||!s.length)return Promise.resolve();if("number"==typeof d&&+d>=t&&h>d)return Promise.resolve();const e=s.filter((e=>"3D"===e.category_type)).map((e=>this.format3DInfo(e)));if(o){if(a)return yield this.loadRest(e,h,{isIdleRest:n,loadSceneAllSuccess:l}),void(yield Promise.allSettled(s.map((e=>r(e.children,!0,h+1)))));const t=Array.isArray(o)?o:[o];for(const i of t){const t=e.find((e=>e.id===i));if(t){yield this.loadSbmOrModel([t]);const e=s.find((e=>e.id===i));e&&(yield r(e.children,!0,h+1))}}yield Promise.allSettled(s.map((e=>r(e.children,!1,h))))}else yield this.loadRest(e,h,{isIdleRest:n,loadSceneAllSuccess:l}),yield Promise.allSettled(s.map((e=>r(e.children,!1,h+1))))}))};yield r(a),n&&d!==t&&0!==this.idleTaskList.length||(this.isLoaded=!0,this.ssp.viewport.setPauseRender(!1).then((()=>{l()})))}))}loadRest(s,i,o){let{isIdleRest:d,loadSceneAllSuccess:n}=o;return e(this,void 0,void 0,(function*(){if(0!==s.length){if(d&&i>t){let e;const t=()=>{this.loadSbmOrModel(s).finally((()=>{const t=this.idleTaskList.findIndex((t=>t===e));-1!==t&&this.idleTaskList.splice(t,1),0!==this.idleTaskList.length||this.isLoaded||(this.isLoaded=!0,this.ssp.viewport.setPauseRender(!1).then((()=>{n()})))}))};return e="function"==typeof requestIdleCallback?requestIdleCallback(t):setTimeout(t),void this.idleTaskList.push(e)}yield this.loadSbmOrModel(s)}}))}loadSbmOrModel(s){return e(this,void 0,void 0,(function*(){if(!this.ssp.viewport.state.isDisposed&&Array.isArray(s)){let e="";if(s.length>0){const[i]=s;e=`${i.userData.pid}_group`,this.isPausedRenderWhileLoadingRest&&i.userData.nodeLevel>t&&this.ssp.viewport.setPauseRender(!0)}if(e){let t=this.ssp.getObjectById(e);t||(t=this.ssp.createGroup({id:e,name:e})),yield Promise.allSettled([this.ssp.addModelForGroup(e,s)])}}}))}}export{s as default};
