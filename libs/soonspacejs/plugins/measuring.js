import t from"soonspacejs";import{LineBasicMaterial as e,DoubleSide as s,MeshBasicMaterial as i,Vector3 as n,TextureLoader as r,SpriteMaterial as o,Sprite as h,BufferGeometry as a,Line as l,Mesh as c,QuadraticBezierCurve3 as p}from"three";const d={m:1,mm:.001,cm:.01,ft:.3048,in:.0254,pt:function(){const t=document.createElement("div");return t.setAttribute("style","height: 1in; visibility: hidden; position: absolute; margin: 0; padding: 0;"),document.body.appendChild(t),.0254/t.clientHeight}()},m=t=>2===t?"²":3===t?"³":"",A=(t,e=1)=>t+m(e),u=(t,e,s,i=1)=>{if(null==s&&(s=e),s===e)return{value:t,unit:A(s)};return{value:t*Math.pow(d[e]/d[s],i),unit:A(s)+m(i)}},y=(t,e)=>t.toFixed(e);var f;!function(t){t.Distance="Distance",t.Area="Area",t.Angle="Angle"}(f||(f={}));const{utils:{randomString:b}}=t;class g{constructor(t){this.ssp=t,this.mode=null,this.options={unit:"m",precision:2},this.objectsStore=new Set,this.onCancel=()=>{},this.onDone=()=>{},this.pointMarkers=[],this.labels=[],this.pointArray=[],this.mousemove=t=>{if(null===this.mode)return;const e=this.getClosestIntersection(t);if(e){if(this.tempPointMarker?this.tempPointMarker.position.set(e.x,e.y,e.z):(this.tempPointMarker=this.createPointMarker(e),this.scene.add(this.tempPointMarker)),this.pointArray.length>0){const t=this.pointArray[this.pointArray.length-1],s=this.tempLine||this.createLine(),i=s.geometry,r=this.pointArray[0],o=this.pointArray[this.pointArray.length-1];if(this.mode===f.Area?i.setFromPoints([o,e,r]):i.setFromPoints([o,e]),this.mode===f.Distance){const s=t.distanceTo(e),i=`${y(u(s,"m",this.options.unit).value,this.options.precision)} ${this.getUnitString()}`,r=new n((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2);this.addOrUpdateTempLabel(i,r)}this.tempLine||(this.scene.add(s),this.tempLine=s)}this.ssp.render()}},this.dblclick=t=>{this.click(t),this.done()},this.click=t=>{if(null===this.mode)return;const e=this.getClosestIntersection(t);if(!e)return;const s=Date.now();if(this.lastClickTime&&s-this.lastClickTime<300)return;this.lastClickTime=s,this.pointArray.push(e);const i=this.pointArray.length,n=this.createPointMarker(e);if(this.pointMarkers.push(n),this.scene.add(n),this.polyline&&(this.polyline.geometry.setFromPoints(this.pointArray),this.tempLabel&&i>1)){const t=this.pointArray[i-2];this.tempLabel.position.set((t.x+e.x)/2,(t.y+e.y)/2,(t.z+e.z)/2),this.scene.add(this.tempLabel),this.labels.push(this.tempLabel),this.tempLabel=void 0}if(this.mode===f.Area&&this.faces){const t=this.faces.geometry,s=this.faces.userData.vertices;s.push(e),t.setFromPoints(s);const i=s.length;if(i>2){const e=[];for(let t=1;t<i-1;++t)e.push(0,t,t+1);t.setIndex(e)}}this.mode===f.Angle&&this.pointArray.length>=3&&this.done(),this.ssp.render()},this.keydown=t=>{"Enter"===t.key?this.done():"Escape"===t.key&&this.cancel()},this.getClosestIntersection=t=>{if(null===this.mode)return;let e=this.ssp.viewport.getIntersects(t);return e&&e.length>0&&(e=e.filter((t=>t.object.name!==g.OBJ_NAME&&t.object.visible)),e.length>0&&e[0].distance<g.MAX_DISTANCE)?e[0].point:null};const{viewport:{scene:e,camera:s}}=t;this.scene=e,this.camera=s}get domElement(){return this.ssp.domElement}start(t=f.Distance,e={}){const{unit:s="m",precision:i=2}=e;this.mode=t,this.options.unit=s,this.options.precision=i,this.ssp.signals.mouseMove.add(this.mousemove),this.ssp.signals.click.add(this.click),this.ssp.signals.dblClick.add(this.dblclick),this.ssp.signals.keyDown.add(this.keydown),this.pointArray=[],this.polyline=this.createLine(),this.scene.add(this.polyline),this.mode===f.Area&&(this.faces=this.createFaces(),this.scene.add(this.faces)),this.domElement.style.cursor="crosshair"}close(){null!==this.mode&&(this.ssp.signals.mouseMove.remove(this.mousemove),this.ssp.signals.click.remove(this.click),this.ssp.signals.dblClick.remove(this.dblclick),this.ssp.signals.keyDown.remove(this.keydown),this.mode=null,this.domElement.style.cursor="",this.pointArray=[],this.tempPointMarker&&this.scene.remove(this.tempPointMarker),this.tempLine&&this.scene.remove(this.tempLine),this.tempLabel&&this.ssp.removeObject(this.tempLabel),this.pointMarkers.forEach((t=>this.scene.remove(t))),this.polyline&&this.scene.remove(this.polyline),this.faces&&this.scene.remove(this.faces),this.curve&&this.scene.remove(this.curve),this.labels.forEach((t=>this.ssp.removeObject(t))),this.tempPointMarker=void 0,this.tempLine=void 0,this.tempLabel=void 0,this.pointMarkers=[],this.polyline=void 0,this.faces=void 0,this.curve=void 0,this.labels=[],this.ssp.render())}cancel(){this.close(),this.onCancel()}clear(){this.objectsStore.forEach((t=>this.ssp.removeObject(t))),this.objectsStore.clear()}initPointMarkerMaterial(){const t=(new r).load("data:image/webp;base64,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");this.spriteMaterial=new o({map:t,depthTest:!1,depthWrite:!1,sizeAttenuation:!1,opacity:.8})}createPointMarker(t){this.spriteMaterial||this.initPointMarkerMaterial();const e=.012,s=new h(this.spriteMaterial);return s.scale.set(e,e,e),t&&s.position.copy(t),s.name=g.OBJ_NAME,s}createLine(t=g.LINE_MATERIAL){const e=new a,s=new l(e,t);return s.frustumCulled=!1,s.name=g.OBJ_NAME,s}createFaces(){const t=new a,e=new c(t,g.MESH_MATERIAL);return e.userData.vertices=[],e.frustumCulled=!1,e.name=g.OBJ_NAME,e}done(){if(null===this.mode)return;let t=!1;const e=this.pointArray.length;if(this.mode===f.Area&&this.polyline)if(e>2){const t=this.pointArray[0];this.polyline.geometry.setFromPoints([...this.pointArray,t]);const e=this.calculateArea(this.pointArray),s=`${y(u(e,"m",this.options.unit,2).value,this.options.precision)} ${this.getUnitString()}`,i=this.getBarycenter(this.pointArray),n=this.createLabel(s);n.position.copy(i),n.element&&(n.element.innerHTML=s),this.labels.push(n)}else t=!0;if(this.mode===f.Distance&&e<2&&(t=!0),this.mode===f.Angle&&this.polyline)if(e>=3){const t=this.pointArray[0],e=this.pointArray[1],s=this.pointArray[2],i=new n(t.x-e.x,t.y-e.y,t.z-e.z).normalize(),r=this.getAngleBisector(t,e,s),o=new n(s.x-e.x,s.y-e.y,s.z-e.z).normalize(),h=this.calculateAngle(t,e,s),a=`${y(h,this.options.precision)} ${this.getUnitString()}`,l=Math.min(t.distanceTo(e),s.distanceTo(e));let c=.3*l,p=e.clone().add(new n(r.x*c,r.y*c,r.z*c));const d=this.createLabel(a);d.position.set(p.x,p.y,p.z),d.element.innerHTML=a,this.labels.push(d),c=.2*l,p=e.clone().add(new n(r.x*c,r.y*c,r.z*c));const m=e.clone().add(new n(i.x*c,i.y*c,i.z*c)),A=e.clone().add(new n(o.x*c,o.y*c,o.z*c));this.curve=this.createCurve(m,p,A),this.scene.add(this.curve)}else t=!0;t||(this.pointMarkers.length>0&&this.pointMarkers.forEach((t=>this.objectsStore.add(t))),this.polyline&&this.objectsStore.add(this.polyline),this.faces&&this.objectsStore.add(this.faces),this.curve&&this.objectsStore.add(this.curve),this.labels.length>0&&this.labels.forEach((t=>this.objectsStore.add(t))),this.pointMarkers=[],this.polyline=void 0,this.faces=void 0,this.curve=void 0,this.labels=[]),this.close(),this.ssp.render(),this.onDone()}addOrUpdateTempLabel(t,e){this.tempLabel||(this.tempLabel=this.createLabel(t)),this.tempLabel.position.set(e.x,e.y,e.z),this.tempLabel.element.innerHTML=t}createLabel(t){const e=document.createElement("div");e.innerHTML=t,e.style.padding="3px 6px",e.style.color="#fff",e.style.fontSize="12px",e.style.position="absolute",e.style.backgroundColor="rgba(25, 25, 25, 0.3)",e.style.borderRadius="12px",e.style.top="0px",e.style.left="0px";const s=this.ssp.createPoiNode({id:b(),element:e,type:"2D"});return s.name=g.LABEL_NAME,s}createCurve(t,e,s){const i=new p(t,e,s).getPoints(4),n=(new a).setFromPoints(i),r=new l(n,g.LINE_MATERIAL);return r.name=g.OBJ_NAME,r}calculateArea(t){let e=0;for(let s=0,i=1,n=2;n<t.length;i++,n++){const r=t[s].distanceTo(t[i]),o=t[i].distanceTo(t[n]),h=t[n].distanceTo(t[s]),a=(r+o+h)/2;e+=Math.sqrt(a*(a-r)*(a-o)*(a-h))}return e}calculateAngle(t,e,s){const i=t,r=e,o=s,h=new n(i.x-r.x,i.y-r.y,i.z-r.z),a=new n(o.x-r.x,o.y-r.y,o.z-r.z);return 180*h.angleTo(a)/Math.PI}getAngleBisector(t,e,s){const i=t,r=e,o=s,h=new n(i.x-r.x,i.y-r.y,i.z-r.z).normalize(),a=new n(o.x-r.x,o.y-r.y,o.z-r.z).normalize();return new n(h.x+a.x,h.y+a.y,h.z+a.z).normalize()}getBarycenter(t){const e=t.length;let s=0,i=0,r=0;return t.forEach((t=>{s+=t.x,i+=t.y,r+=t.z})),new n(s/e,i/e,r/e)}getUnitString(){return this.mode===f.Distance?A(this.options.unit):this.mode===f.Area?`${A(this.options.unit,2)}`:this.mode===f.Angle?"°":""}numberToString(t){if(t<1e-4)return t.toString();let e=2;return t<.01?e=4:t<.1&&(e=3),t.toFixed(e)}}g.LINE_MATERIAL=new e({color:16773120,linewidth:2,opacity:.8,transparent:!0,side:s,depthWrite:!1,depthTest:!1}),g.MESH_MATERIAL=new i({color:8900346,transparent:!0,opacity:.8,side:s,depthWrite:!1,depthTest:!1}),g.MAX_DISTANCE=500,g.OBJ_NAME="object_for_measure"+b(),g.LABEL_NAME="label_for_measure"+b();export{f as MeasuringMode,g as default};
